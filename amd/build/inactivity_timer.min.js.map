{"version":3,"sources":["../src/inactivity_timer.js"],"names":["define","$","Config","ModalFactory","Log","InactivityTimer","idleThreshold","sessionTimeout","sessionTimeoutWarnThreshold","idleTime","active","warned","timeoutModal","videos","loggedOut","console","log","prototype","init","document","mousemove","activate","keypress","scroll","setInterval","debug","trigger","secondsUntilTimeout","threshold","each","index","video","hasOwnProperty","id","on","updateTimeoutWarnModal","showTimeoutWarnModal","setBody","getTimeoutWarnModal","modal","isVisible","show","hideTimeoutWarnModal","hide","callback","create","type","types","DEFAULT","title","done","logout","message","alert","window","location","href","M","cfg","wwwroot","sesskey"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\ndefine(['jquery', 'core/config', 'core/modal_factory', 'core/log'], function($, Config, ModalFactory, Log) {\n\n    /**\n     * @param {int} idleThreshold Milliseconds to elapse when user is considered idle\n     * @param {int} sessionTimeout Seconds to elapse of inactivity to logout user.\n     * @param {int} sessionTimeoutWarnThreshold Seconds before timeout to warn user.\n     * @constructor\n     */\n    let InactivityTimer = function(idleThreshold, sessionTimeout, sessionTimeoutWarnThreshold) {\n        this.idleThreshold = idleThreshold;\n        this.sessionTimeout = sessionTimeout;\n        this.sessionTimeoutWarnThreshold = sessionTimeoutWarnThreshold;\n        this.idleTime = 0;\n        this.active = true;\n        this.warned = false;\n        this.timeoutModal = null;\n        this.videos = {};\n        this.loggedOut = false;\n\n        console.log(\"NEW IT\", this);\n    };\n\n    InactivityTimer.prototype.init = function() {\n        $(document).mousemove(() => {\n            this.activate();\n        });\n\n        $(document).keypress(() => {\n            this.activate();\n        });\n\n        $(document).scroll(() => {\n            this.activate();\n        });\n\n        setInterval(() => {\n            this.idleTime = this.idleTime + 1000;\n            if (this.idleTime >= this.idleThreshold) {\n                if (this.active) {\n                    Log.debug(\"INACTIVITY_TIMER: EVENT inactive\");\n                    $(this).trigger('inactive');\n                }\n                this.active = false;\n            }\n\n            let secondsUntilTimeout = this.sessionTimeout - (this.idleTime / 1000);\n\n            if (this.sessionTimeout > 0 && secondsUntilTimeout <= 0) {\n                $(this).trigger('session_timeout');\n            }\n            if (this.sessionTimeout > 0 && this.sessionTimeoutWarnThreshold > 0) {\n                let threshold = this.sessionTimeout - this.sessionTimeoutWarnThreshold;\n                if (!this.warned && (this.idleTime / 1000) >= threshold) {\n                    $(this).trigger('session_timeout_warn');\n\n                }\n            }\n\n            // Check for videos on the page.\n            $(\"video\").each((index, video) => {\n                if (!this.videos.hasOwnProperty(video.id)) {\n                    Log.debug(\"VIDEO DETECTED:  video.id\");\n                    Log.debug(video);\n                    this.videos[video.id] = video;\n                    $(video).on(\"timeupdate\", () => {\n                        this.activate();\n                    });\n                }\n            });\n\n            // Always update warn modal text, even if it's hidden.\n            this.updateTimeoutWarnModal();\n        }, 1000);\n\n        $(this).on('session_timeout_warn', () => {\n            // Already warned.\n            if (this.warned) {\n                return;\n            }\n            this.warned = true;\n            this.updateTimeoutWarnModal();\n            this.showTimeoutWarnModal();\n        });\n    };\n\n    InactivityTimer.prototype.updateTimeoutWarnModal = function() {\n        let secondsUntilTimeout = this.sessionTimeout - (this.idleTime / 1000);\n        if (secondsUntilTimeout < 0) {\n            secondsUntilTimeout = 0;\n        }\n        if (this.timeoutModal) {\n            this.timeoutModal.setBody('You have been inactive and will be logged out in ' + secondsUntilTimeout + ' seconds.');\n        }\n    };\n\n    InactivityTimer.prototype.showTimeoutWarnModal = function() {\n        this.getTimeoutWarnModal((modal) => {\n            if (!modal.isVisible()) {\n                // Update just in case.\n                this.updateTimeoutWarnModal();\n                modal.show();\n            }\n        });\n    };\n\n    InactivityTimer.prototype.hideTimeoutWarnModal = function() {\n        this.getTimeoutWarnModal((modal) => {\n            modal.hide();\n        });\n    };\n\n    /**\n     * Manually change timer to active (not idling).\n     */\n    InactivityTimer.prototype.activate = function() {\n        this.idleTime = 0;\n        if (!this.active) {\n            $(this).trigger('active');\n        }\n        if (this.timeoutModal && this.timeoutModal.isVisible()) {\n            this.hideTimeoutWarnModal();\n        }\n        this.active = true;\n        this.warned = false;\n    };\n\n    /**\n     * Get modal popup to warn user their session is going to timeout.\n     *\n     * @param {Function} callback\n     */\n    InactivityTimer.prototype.getTimeoutWarnModal = function(callback) {\n        if (this.timeoutModal) {\n            callback(this.timeoutModal);\n            return;\n        }\n\n        ModalFactory.create({\n            type: ModalFactory.types.DEFAULT,\n            title: 'Inactivity'\n        }).done((modal) => {\n            this.timeoutModal = modal;\n            callback(this.timeoutModal);\n        });\n    };\n\n    /**\n     * Log out the user but display a message first.\n     *\n     * @param {string} message\n     */\n    InactivityTimer.prototype.logout = function(message) {\n        if (this.loggedOut) {\n            return;\n        }\n        if (!message) {\n            message = 'You are being logged out due to inactivity. Please login again.';\n        }\n        this.loggedOut = true;\n        alert(message);\n        window.location.href = M.cfg.wwwroot + \"/login/logout.php?loginpage=1&sesskey=\" + M.cfg.sesskey;\n    };\n\n    return InactivityTimer;\n});\n"],"file":"inactivity_timer.min.js"}